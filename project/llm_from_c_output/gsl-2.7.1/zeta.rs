use std::f64::consts::{PI, LN_2, EULER};
use std::f64;

const LOG_TWO_PI: f64 = 1.8378770664093454835606594728111235279723;
const GSL_DBL_EPSILON: f64 = 2.2204460492503131e-16;
const GSL_ROOT5_DBL_EPSILON: f64 = 1.4901161193847656e-8;

#[derive(Debug, Clone, Copy)]
pub struct SfResult {
    pub val: f64,
    pub err: f64,
}

impl SfResult {
    pub fn new(val: f64, err: f64) -> Self {
        Self { val, err }
    }
}

#[derive(Debug, Clone)]
struct ChebSeries {
    data: Vec<f64>,
    order: usize,
    a: f64,
    b: f64,
    order_sp: usize,
}

impl ChebSeries {
    fn new(data: &[f64], order: usize, a: f64, b: f64, order_sp: usize) -> Self {
        Self {
            data: data.to_vec(),
            order,
            a,
            b,
            order_sp,
        }
    }
}

fn cheb_eval_e(cs: &ChebSeries, x: f64) -> SfResult {
    let d = 0.0;
    let dd = 0.0;
    let y = (2.0 * x - cs.a - cs.b) / (cs.b - cs.a);
    let y2 = 2.0 * y;
    let mut e = 0.0;
    
    for j in (1..=cs.order).rev() {
        let temp = d;
        d = y2 * d - dd + cs.data[j];
        e += (y2 * temp).abs() + dd.abs() + cs.data[j].abs();
        dd = temp;
    }
    
    let temp = d;
    d = y * d - dd + 0.5 * cs.data[0];
    e += (y * temp).abs() + dd.abs() + 0.5 * cs.data[0].abs();
    
    let result = d;
    let err = GSL_DBL_EPSILON * e + (cs.data[cs.order]).abs();
    
    SfResult::new(result, err)
}

// Zeta function tables and constants
static ZETA_XLT1_DATA: [f64; 14] = [
    1.48018677156931561235192914649,
    0.25012062539889426471999938167,
    0.00991137502135360774243761467,
    -0.00012084759656676410329833091,
    -4.7585866367662556504652535281e-6,
    2.2229946694466391855561441361e-7,
    -2.2237496498030257121309056582e-9,
    -1.0173226513229028319420799028e-10,
    4.3756643450424558284466248449e-12,
    -6.2229632593100551465504090814e-14,
    -6.6116201003272207115277520305e-16,
    4.9477279533373912324518463830e-17,
    -1.0429819093456189719660003522e-18,
    6.9925216166580021051464412040e-21,
];

static ZETA_XGT1_DATA: [f64; 30] = [
    19.3918515726724119415911269006,
    9.1525329692510756181581271500,
    0.2427897658867379985365270155,
    -0.1339000688262027338316641329,
    0.0577827064065028595578410202,
    -0.0187625983754002298566409700,
    0.0039403014258320354840823803,
    -0.0000581508273158127963598882,
    -0.0003756148907214820704594549,
    0.0001892530548109214349092999,
    -0.0000549032199695513496115090,
    8.7086484008939038610413331863e-6,
    6.4609477924811889068410083425e-7,
    -9.6749773915059089205835337136e-7,
    3.6585400766767257736982342461e-7,
    -8.4592516427275164351876072573e-8,
    9.9956786144497936572288988883e-9,
    1.4260036420951118112457144842e-9,
    -1.1761968823382879195380320948e-9,
    3.7114575899785204664648987295e-10,
    -7.4756855194210961661210215325e-11,
    7.8536934209183700456512982968e-12,
    9.9827182259685539619810406271e-13,
    -7.5276687030192221587850302453e-13,
    2.1955026393964279988917878654e-13,
    -4.1934859852834647427576319246e-14,
    4.6341149635933550715779074274e-15,
    2.3742488509048340106830309402e-16,
    -2.7276516388124786119323824391e-16,
    7.8473570134636044722154797225e-17,
];

static ZETAM1_INTER_DATA: [f64; 24] = [
    -21.7509435653088483422022339374,
    -5.63036877698121782876372020472,
    0.0528041358684229425504861579635,
    -0.0156381809179670789342700883562,
    0.00408218474372355881195080781927,
    -0.0010264867349474874045036628282,
    0.000260469880409886900143834962387,
    -0.0000676175847209968878098566819447,
    0.0000179284472587833525426660171124,
    -4.83238651318556188834107605116e-6,
    1.31913788964999288471371329447e-6,
    -3.63760500656329972578222188542e-7,
    1.01146847513194744989748396574e-7,
    -2.83215225141806501619105289509e-8,
    7.97733710252021423361012829496e-9,
    -2.25850168553956886676250696891e-9,
    6.42269392950164306086395744145e-10,
    -1.83363861846127284505060843614e-10,
    5.25309763895283179960368072104e-11,
    -1.50958687042589821074710575446e-11,
    4.34997545516049244697776942981e-12,
    -1.25597782748190416118082322061e-12,
    3.61280740072222650030134104162e-13,
    -9.66437239205745207188920348801e-14,
];

static HZETA_C: [f64; 15] = [
    1.00000000000000000000000000000,
    0.083333333333333333333333333333,
    -0.00138888888888888888888888888889,
    0.000033068783068783068783068783069,
    -8.2671957671957671957671957672e-7,
    2.0876756987868098979210090321e-8,
    -5.2841901386874931848476822022e-10,
    1.3382536530684678832826980975e-11,
    -3.3896802963225828668301953912e-13,
    8.5860620562778445641359054504e-15,
    -2.1748686985580618730415164239e-16,
    5.5090028283602295152026526089e-18,
    -1.3954464685812523340707686264e-19,
    3.5347070396294674716932299778e-21,
    -8.9535174270375468504026113181e-23,
];

static ZETAM1_POS_INT_TABLE: [f64; 101] = [
    -1.5,
    0.0,
    0.644934066848226436472415166646,
    0.202056903159594285399738161511,
    0.082323233711138191516003696541,
    0.036927755143369926331365486457,
    0.017343061984449139714517929790,
    0.008349277381922826839797549849,
    0.004077356197944339378685238508,
    0.002008392826082214417852769232,
    0.000994575127818085337145958900,
    0.000494188604119464558702282526,
    0.000246086553308048298637998047,
    0.000122713347578489146751836526,
    0.000061248135058704829258545105,
    0.000030588236307020493551728510,
    0.000015282259408651871732571487,
    7.6371976378997622736002935630e-6,
    3.8172932649998398564616446219e-6,
    1.9082127165539389256569577951e-6,
    9.5396203387279611315203868344e-7,
    4.7693298678780646311671960437e-7,
    2.3845050272773299000364818675e-7,
    1.1921992596531107306778871888e-7,
    5.9608189051259479612440207935e-8,
    2.9803503514652280186063705069e-8,
    1.4901554828365041234658506630e-8,
    7.4507117898354294919810041706e-9,
    3.7253340247884570548192040184e-9,
    1.8626597235130490064039099454e-9,
    9.3132743241966818287176473502e-10,
    4.6566290650337840729892332512e-10,
    2.3283118336765054920014559759e-10,
    1.1641550172700519775929738354e-10,
    5.8207720879027008892436859891e-11,
    2.9103850444970996869294252278e-11,
    1.4551921891041984235929632245e-11,
    7.2759598350574810145208690123e-12,
    3.6379795473786511902372363558e-12,
    1.8189896503070659475848321007e-12,
    9.0949478402638892825331183869e-13,
    4.5474737830421540267991120294e-13,
    2.2737368458246525152268215779e-13,
    1.1368684076802278493491048380e-13,
    5.6843419876275856092771829675e-14,
    2.8421709768893018554550737049e-14,
    1.4210854828031606769834307141e-14,
    7.1054273952108527128773544799e-15,
    3.5527136913371136732984695340e-15,
    1.7763568435791203274733490144e-15,
    8.8817842109308159030960913863e-16,
    4.4408921031438133641977709402e-16,
    2.2204460507980419839993200942e-16,
    1.1102230251410661337205445699e-16,
    5.5511151248454812437237365905e-17,
    2.7755575621361241725816324538e-17,
    1.3877787809725232762839094906e-17,
    6.9388939045441536974460853262e-18,
    3.4694469521659226247442714961e-18,
    1.7347234760475765720489729699e-18,
    8.6736173801199337283420550673e-19,
    4.3368086900206504874970235659e-19,
    2.1684043449972197850139101683e-19,
    1.0842021724942414063012711165e-19,
    5.4210108624566454109187004043e-20,
    2.7105054312234688319546213119e-20,
    1.3552527156101164581485233996e-20,
    6.7762635780451890979952987415e-21,
    3.3881317890207968180857031004e-21,
    1.6940658945097991654064927471e-21,
    8.4703294725469983482469926091e-22,
    4.2351647362728333478622704833e-22,
    2.1175823681361947318442094398e-22,
    1.0587911840680233852265001539e-22,
    5.2939559203398703238139123029e-23,
    2.6469779601698529611341166842e-23,
    1.3234889800848990803094510250e-23,
    6.6174449004244040673552453323e-24,
    3.3087224502121715889469563843e-24,
    1.6543612251060756462299236771e-24,
    8.2718061255303444036711056167e-25,
    4.1359030627651609260093824555e-25,
    2.0679515313825767043959679193e-25,
    1.0339757656912870993284095591e-25,
    5.1698788284564313204101332166e-26,
    2.5849394142282142681277617708e-26,
    1.2924697071141066700381126118e-26,
    6.4623485355705318034380021611e-27,
    3.2311742677852653861348141180e-27,
    1.6155871338926325212060114057e-27,
    8.0779356694631620331587381863e-28,
    4.0389678347315808256222628129e-28,
    2.0194839173657903491587626465e-28,
    1.0097419586828951533619250700e-28,
    5.0487097934144756960847711725e-29,
    2.5243548967072378244674341938e-29,
    1.2621774483536189043753999660e-29,
    6.3108872417680944956826093943e-30,
    3.1554436208840472391098412184e-30,
    1.5777218104420236166444327830e-30,
    7.8886090522101180735205378276e-31,
];

static ZETA_NEG_INT_TABLE: [f64; 50] = [
    -0.083333333333333333333333333333,
    0.008333333333333333333333333333,
    -0.003968253968253968253968253968,
    0.004166666666666666666666666667,
    -0.007575757575757575757575757576,
    0.021092796092796092796092796093,
    -0.083333333333333333333333333333,
    0.44325980392156862745098039216,
    -3.05395433027011974380395433027,
    26.4562121212121212121212121212,
    -281.460144927536231884057971014,
    3607.5105463980463980463980464,
    -54827.583333333333333333333333,
    974936.82385057471264367816092,
    -2.0052695796688078946143462272e7,
    4.7238486772162990196078431373e8,
    -1.2635724795916666666666666667e10,
    3.8087931125245368811553022079e11,
    -1.2850850499305083333333333333e13,
    4.8241448354850170371581670362e14,
    -2.0040310656516252738108421663e16,
    9.1677436031953307756992753623e17,
    -4.5979888343656503490437943262e19,
    2.5180471921451095697089023320e21,
    -1.5001733492153928733711440151e23,
    9.6899578874635940656497942895e24,
    -6.7645882379292820990945242302e26,
    5.089065946866